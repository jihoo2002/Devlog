# 12ê°• ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼
### ğŸ“ ê¹€ì˜í•œ ì‹¤ì „ ìë°” ê³ ê¸‰í¸ 3 - ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸

í•˜ë‚˜ì˜ ë©”ì¸ ìŠ¤ë ˆë“œë¡œ ì‘ì—…í•˜ë©´ ì‹¤í–‰ ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ê²Œ ëœë‹¤.<br>
ë”°ë¼ì„œ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ ë™ì‹œì— ì‚¬ìš©í•´ì„œ ì‘ì—…ì„ ë” ë¹¨ë¦¬ ì²˜ë¦¬í•´ë³´ë„ë¡ í•˜ì

## ìŠ¤ë ˆë“œ í’€ ì‚¬ìš©
```java
        ExecutorService es = Executors.newFixedThreadPool(2);
        long startTime = System.currentTimeMillis();

        // 1. ì‘ì—…ì„ ë¶„í• í•œë‹¤.
        SumTask task1 = new SumTask(1, 4);
        SumTask task2 = new SumTask(5, 8);

        // 2. ë¶„í• í•œ ì‘ì—…ì„ ì²˜ë¦¬í•œë‹¤.
        Future<Integer> future1 = es.submit(task1);
        Future<Integer> future2 = es.submit(task2);

        //3. join - ì²˜ë¦¬í•œ ê²°ê³¼ë¥¼ í•©ì¹¨, get - ê²°ê³¼ê°€ ë‚˜ì˜¬ ë–„ê¹Œì§€ ëŒ€ê¸°
        Integer result1 = future1.get();
        Integer result2 = future2.get();

        int sum = result1 + result2;
        long endTime = System.currentTimeMillis();
        log("time: " + (endTime - startTime) + "ms, sum: " + sum);
        es.shutdown(); // ìë°” 19+ë¶€í„° es.close()ê°€ ê°€ëŠ¥í•˜ë‹¤ê³  í•œë‹¤..
```

1. Executors.newFixedThreadPool(2)ëŠ”
ìµœëŒ€ 2ê°œì˜ ìŠ¤ë ˆë“œë¥¼ ì œê³µí•˜ëŠ” ìŠ¤ë ˆë“œ í’€ì„ ë§Œë“ ë‹¤.

```java
    static class SumTask implements Callable<Integer> {
        int startValue;
        int endValue;

        public SumTask(int startValue, int endValue) {
            this.startValue = startValue;
            this.endValue = endValue;
        }

        @Override
        public Integer call() {
            log("ì‘ì—… ì‹œì‘");
            int sum = 0;
            for (int i = startValue; i <= endValue; i++) {
                int calculated = HeavyJob.heavyTask(i);
                sum += calculated;
            }
            log("ì‘ì—… ì™„ë£Œ result: " + sum);
            return sum;
        }
    }
```
2. `SumTask` ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ ì‘ì—…ì„ ë‘ê°œë¡œ ë¶„í• í•œë‹¤.
3. ìŠ¤ë ˆë“œí’€ì˜ `submit`ë©”ì„œë“œë¥¼ í†µí•´ ìŠ¤ë ˆë“œ í’€ ì ì—…ì„ ë§¡ê²¨ Future ê°ì²´ë¥¼ ë°›ê³ 
4. ì‹¤ì œ ê²°ê³¼ê°€ ë‚˜ì˜¬ë•Œê¹Œì§€ ëŒ€ê¸°í•œë‹¤.

ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ í†µí•´ ì‹¤í–‰ì‹œê°„ì´ ë” ë‹¨ì¶•ë˜ê³  `Future`ë¡œ ë°˜í™˜ê°’ì„ ì‰½ê²Œ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤.
í•˜ì§€ë§Œ ë¶„í• /ë³‘í•© ë¡œì§ì„ ì§ì ‘ ì§œì•¼í•˜ëŠ” ë‹¨ì ì´ ìˆë‹¤

---

## Fork/join íŒ¨í„´

ì§€ê¸ˆê¹Œì§€ëŠ” ê°œë°œìê°€ ì‘ì—…ì„ ì§ì ‘ ë¶„í• í•˜ê³  ì²˜ë¦¬í•˜ê³  ì²˜ë¦¬ëœ ê²°ê³¼ë¥¼ í•©ì³¤ë‹¤
í•˜ì§€ë§Œ ìë°”ì—ì„œ Fork/Join í”„ë ˆì„ì›Œí¬ë¥¼ í†µí•´ ìœ„ íŒ¨í„´ì„ ë” ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

```java
public class ForkJoinMain1 {
    public static void main(String[] args) {
        List<Integer> data = IntStream.rangeClosed(1, 8)
                .boxed()
                .toList();
        log("[ìƒì„±]" + data);

        //forkJoinPool ìƒì„± ë° ì‘ì—… ìˆ˜í–‰
        long startTime = System.currentTimeMillis();
        ForkJoinPool pool = new ForkJoinPool(10);
        SumTask task = new SumTask(data); //1-8

        //ë³‘ë ¬ë¡œ í•©ì„ êµ¬í•œ í›„ ê²°ê³¼ ì¶œë ¥
        Integer result = pool.invoke(task);
        pool.shutdown();
        long endTime = System.currentTimeMillis();
        log("time: " + (endTime - startTime) + "ms, sum: " + result);
        log("pool: " + pool);
    }
}
```
ForkJoinPoolì„ ìƒì„±í•´ì„œ ìµœëŒ€ 10ì˜ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìŠ¤ë ˆë“œ í’€ì„ ìƒì„±í•œë‹¤.
pool.invoke(task)ë¥¼ í†µí•´ SumTaskë¥¼ ìŠ¤ë ˆë“œ í’€ì— ì „ë‹¬í•´ì„œ ë³‘ë ¬ ì‹¤í–‰ì„ ì‹œì‘í•œë‹¤.

```java
    @Override
    protected Integer compute() {
        //ì‘ì—… ë²”ìœ„ê°€ ì‘ìœ¼ë©´ ì§ì ‘ í™•ì‚°
        if (list.size() <= THRESHOLD) {
            log("[ì²˜ë¦¬ ì‹œì‘]" + list);
            int sum = list.stream()
                    .mapToInt(Integer::intValue)
                    .sum();
            log("[ì²˜ë¦¬ ì™„ë£Œ]" + list + "-> sum: " + sum);
            return sum;
        } else {
            //ì‘ì—… ë²”ìœ„ê°€ í¬ë©´ ë°˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë³‘ë ¬ ì²˜ë¦¬
            int mid = list.size() / 2;
            List<Integer> leftList = list.subList(0, mid);
            List<Integer> rightLIst = list.subList(mid, list.size());
            log("[ë¶„í• ]" + list + "-> LEFT: " + leftList + ", RIGHT: " + rightLIst);

            SumTask leftTask = new SumTask(leftList);
            SumTask rightTask = new SumTask(rightLIst);

            //ì™¼ìª½ ì‘ì—…ì€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ì²˜ë¦¬
            leftTask.fork();
            // ì˜¤ë¥¸ìª½ ì‘ì—…ì€ í˜„ì œ ìŠ¤ë ˆë“œì—ì„œ ì²˜ë¦¬
            int rightResult = rightTask.compute();

            //ì™¼ìª½ ì‘ì—… ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¼
            int leftResult = leftTask.join();
            //ì™¼ìª½ê³¼ ì˜¤ë¥¸ìª½ ì‘ì—… ê²°ê³¼ í•©ì¹¨
            int joinSum = leftResult + rightResult;
            log("LEFT[" + leftResult + "] RIGHT[" + rightResult + "] joinSum: " + joinSum);
            return joinSum;
        }
    }
```
ì¦‰, `SumTask` í´ë˜ìŠ¤ì—ì„œ `compute()` ë‚´ë¶€ì—ì„œ ì‘ì—…ì˜ ë¡œì§ì„ ì •ì˜í•˜ê³ ,
`ForkJoinMain1` í´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ `invoke()`ë¥¼ í†µí•´ ì‹¤ì œ ì‘ì—… ì‹¤í–‰ ê³¼ì •ìœ¼ë¡œ ì§„í–‰ëœë‹¤.

---

## Fork/Join í”„ë ˆì„ì›Œí¬ - ê³µìš© í’€
ê³µìš© í’€(common pool)ì€ `Fork/Join` ì‘ì—…ì„ ìœ„í•´ ìë°”ê°€ ì œê³µí•˜ëŠ” ìŠ¤ë ˆë“œ í’€ì´ë‹¤.

```java
List<Integer> data  = IntStream.rangeClosed(1, 8)
                        .boxed()
                        .toList();

SumTask task =  new SumTask(data);
Integer result = task.invoke(); //ê³µìš© í’€ ì‚¬ìš©
```
ì´ì „ì— `ForkJoinPool` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ `pool.invoke(take)`ë¥¼ í†µí•´ í’€ì— ì§ì ‘ ì‘ì—…ì„ ìš”ì²­í•´ì•¼ í•˜ì§€ë§Œ
ê³µìš©í’€ì„ ì‚¬ìš©í•˜ë©´ ë³„ë„ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì§€ ì•Šì•„ë„ ìë°”ê°€ ê³µìš©í’€ì„ ì‚¬ìš©í•´ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ í•˜ê²Œ ë„ì™€ì¤€ë‹¤.
ê³µìš©í’€ì€ JVMì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ìœ ì§€ë˜ê¸° ë•Œë¬¸ì— ë³„ë„ë¡œ í’€ì„ ì¢…ë£Œí•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

### Fork/Join ê³µìš© í’€ì˜ íŠ¹ì§•
- ì‹œìŠ¤í…œ ì „ì²´ì—ì„œ ê³µìœ  
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê³µìœ ë¨
- ìë™ ìƒì„±ê³¼ í¸ë¦¬í•œ ì‚¬ìš©
    - ë³„ë„ë¡œ ìƒì„± x, ForkJoinPool.commonPool()ë¥¼ í†µí•´ ì ‘ê·¼ ê°€ëŠ¥
- ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ í™œìš©
    - ìë°” 8ì˜ ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ë‚´ë¶€ì ìœ¼ë¡œ ê³µìš© í’€ ì‚¬ìš©
- ìì› íš¨ìœ¨ì„± 
    - ì—¬ëŸ¬ ê³³ì—ì„œ ë³„ë„ í’€ì„ ìƒì„±í•˜ëŠ” ëŒ€ì‹ ì— ê³µìš© í’€ì„ ì‚¬ìš©í•´ ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬
- ë³‘ë ¬ ìˆ˜ì¤€ ìë™ ì„¤ì •
    - ì‹œìŠ¤í…œì˜ ê°€ìš© í”„ë¡œì„¸ì„œ ìˆ˜ì—ì„œ 1ì„ ëº€ ê°’ìœ¼ë¡œ ë³‘ë ¬ ìˆ˜ì¤€ì´ ì„¤ì •ë¨

---

## ê³µìš© í’€ vs ì»¤ìŠ¤í…€ í’€

### ì»¤ìŠ¤í…€ Fork/Join í’€
```java
ForkJoinPool pool = new ForkJoinPool();
Integer result = pool.invoke(task);
```

### ê³µìš© í’€
```java
Integer result = task.invoke();
```
ì»¤ìŠ¤í…€ í’€ê³¼ ê³µìš© í’€ì˜ ì°¨ì´ì ì€ ë¬´ì—‡ì¼ê¹Œ?

### ì°¨ì´ì  
1. ìì›ê´€ë¦¬ 
- ì»¤ìŠ¤í…€ í’€ì€ ëª…ì‹œì ìœ¼ë¡œ ìƒì„±í•˜ê³  ê´€ë¦¬, ê³µìš©í’€ì€ ì‹œìŠ¤í…œì—ì„œ ìë™ ê´€ë¦¬
2. ì¬ì‚¬ìš©ì„± 
- ê³µìš© í’€ì€ ì—¬ëŸ¬ê³³ì—ì„œ ê³µìœ  ê°€ëŠ¥, ì»¤ìŠ¤í…€ í’€ì€ x
3. ì„¤ì • ì œì–´
- ì»¤ìŠ¤í…€ í’€ì€ ë³‘ë ¬ìˆ˜ì¤€ê³¼ ìŠ¤ë ˆë“œ íŒ©í† ë¦¬ ë“± ì„¸ë¶€ ì œì–´ ê°€ëŠ¥, ê³µìš© í’€ì€ ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
4. ë¼ì´í”„ì‚¬ì´í´ 
- ì»¤ìŠ¤í…€ í’€ì€ ëª…ì‹œì ìœ¼ë¡œ ì¢…ë£Œ, ê³µìš©í’€ì€ JVMì´ ê´€ë¦¬í•¨ìœ¼ë¡œ ëª…ì‹œì ìœ¼ë¡œ ì¢…ë£Œí•˜ì§€ ì•Šì•„ë„ ë¨.

---

## ìë°” ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼
```java
int sum = IntStream.rangeClosed(1, 8)
            .parallel() //ì¶”ê°€
            .map(HeavyJob::heavyTask)
            .reduce(0, (a, b) -> a + b);//sum()
```
ì§ì ‘ ìŠ¤ë ˆë“œë¥¼ ë§Œë“¤ í•„ìš” ì—†ì´ parallel() ë©”ì„œë“œë§Œ í˜¸ì¶œí•˜ë©´ ìŠ¤íŠ¸ë¦¼ì´ ìë™ìœ¼ë¡œ ë³‘ë ¬ ì²˜ë¦¬ëœë‹¤.
ë”°ë¼ì„œ  parallel() ì„ ì–¸ì„ í†µí•´ ë³µì¡í•œ ë©€í‹°ìŠ¤ë ˆë“œ ì½”ë“œ ì—†ì´ ìŠ¤íŠ¸ë¦¼ì„ ë³‘ë ¬ë¡œ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

---

## ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ ì‚¬ìš©ì‹œ ì£¼ì˜ì 
parallel()ë¥¼ ì‚¬ìš©í•œ ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ìŠ¤ë ˆë“œê°€ ì£¼ë¡œ ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” I/O ë°”ìš´ë“œ ì‘ì—…ì—ëŠ” ì í•©í•˜ì§€ ì•Šë‹¤.
ë³‘ë ¬ìŠ¤íŠ¸ë¦¼ì€ ê¸°ë³¸ì €ê¸ë¡œ CPU ì½”ì–´ ìˆ˜ì— ë§ì¶° ìŠ¤ë ˆë“œê°€ í• ë‹¹ë˜ê¸°ì— ì—°ì‚°ì´ ë§ì€ CPU ë°”ìš´ë“œ ì‘ì—…ì—ì„œ ì„±ëŠ¥ ì´ì ì„ ë³¼ ìˆ˜ ìˆë‹¤.
ê³µìš©í’€ì€ ë³„ë„ì˜ í’€ ìƒì„± ì—†ì´ íš¨ìœ¨ì ì¸ ë³‘ë ¬ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ì§€ë§Œ ë¸”ë¡œí‚¹ ì‘ì—…ì´ë‚˜ íŠ¹ìˆ˜í•œ ì„¤ì •ì´ í•„ìš”í•  ê²½ìš°ì—ëŠ”
ì»¤ìŠ¤í…€ í’€ì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.

> ì‹¤ë¬´ì—ì„œ ê³µìš© í’€ì€ ì ˆëŒ€ I/O ë°”ìš´ë“œ ì‘ì—… xxxx
> ê³µìš© í’€ì„ í†µí•´ ì™¸ë¶€ API í˜¸ì¶œì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ê³  ê¸°ë‹¤ë¦¬ëŠ” ê²½ìš°, 
> ì™¸ë¶€ APIë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì‘ë‹µì´ ëŠ¦ê²Œ ì˜¨ë‹¤ë©´ ê³µìš© í’€ ë‚´ ìŠ¤ë ˆë“œ ëª¨ë‘ I/O ì‘ë‹µì„ ëŒ€ê¸°í•˜ê²Œ ëœë‹¤.
> ì¦‰, ëª¨ë“  ìš”ì²­ì´ ê³µìš© í’€ì˜ ìŠ¤ë ˆë“œë¥¼ ê¸°ë‹¤ë¦¬ë©° ì‘ì—…ì´ ë‹¤ ëŒ€ê¸°ë˜ì–´ ë°€ë¦¬ê²Œ ëœë‹¤!!


---

## ë³„ë„ì˜ í’€ ì‚¬ìš©
i/o ë°”ìš´ë“œ ì‘ì—…ì²˜ëŸ¬ ëŒ€ê¸°ê°€ ê¸´ ê²½ìš° ì „ìš© ìŠ¤ë ˆë“œ í’€ì„ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê¶Œì¥ëœë‹¤.

```java
    public static void main(String[] args) throws InterruptedException {

        //ìš”ì²­ í’€ ì¶”ê°€
        ExecutorService requestPool = Executors.newFixedThreadPool(100);

        //logic ì²˜ë¦¬ ì „ìš© ìŠ¤ë ˆë“œ í’€ ì¶”ê°€
        ExecutorService logicPool = Executors.newFixedThreadPool(400);

        int nThreads = 3;
        for (int i = 0; i < nThreads; i++) {
            String requestName = "request" + i;
            requestPool.submit(() -> logic(requestName, logicPool));
            Thread.sleep(100);
        }
        requestPool.shutdown();
        logicPool.shutdown();
    }
```
ìµœëŒ€ 400ê°œì˜ ìŠ¤ë ˆë“œë¥¼ ê°€ì§„ ë³„ë„ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì „ìš© ìŠ¤ë ˆë“œë¥¼ ì¶”ê°€í•´ì„œ ë³‘ë ¬ ì‘ì—… ì²˜ë¦¬ë¥¼ í•˜ëŠ” ì½”ë“œì´ë‹¤.
```java
    private static void logic(String requestName, ExecutorService es) {
        log("[" + requestName + "] start");
        long startTime = System.currentTimeMillis();

        List<Future<Integer>> futures = IntStream.range(1, 4)
                .mapToObj(i -> es.submit(() -> HeavyJob.heavyTask(i, requestName)))
                .toList();

        int sum = futures.stream()
                .mapToInt(f -> {
                    try {
                        return f.get();
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                }).sum();

        long endTime = System.currentTimeMillis();
        log("[" + requestName + "] time: " + (endTime - startTime) + "ms, sum : " + sum);
    }
```
ì´ë ‡ê²Œ ì „ìš© ìŠ¤ë ˆë“œ í’€ì„ ë§Œë“¤ì–´ ì²˜ë¦¬í•˜ë©´ ìš”ì²­ë³„ ì²˜ë¦¬ ì‹œê°„ì´ ì§€ì—°ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆê³ ,
ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•´ ê³µìš© í’€ ë³‘ëª© í˜„ìƒì„ ë§‰ì„ ìˆ˜ ìˆë‹¤.

---

## ì£¼ì˜ ì‚¬í•­
ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ì²˜ìŒë¶€í„° Fork/Join ê³µìš© í’€ê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆê¸° ë•Œë¬¸ì—
ë°˜ë“œì‹œ CPU ë°”ìš´ë“œ ì‘ì—…ì—ì„œ ì‚¬ìš©ë˜ì–´ì•¼ í•œë‹¤.
