# 12ê°• ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼
### ğŸ“ ê¹€ì˜í•œ ì‹¤ì „ ìë°” ê³ ê¸‰í¸ 3 - ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸



í•˜ë‚˜ì˜ ë©”ì¸ ìŠ¤ë ˆë“œë¡œ ì‘ì—…í•˜ë©´ ì‹¤í–‰ ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ê²Œ ëœë‹¤.<br>
ë”°ë¼ì„œ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ ë™ì‹œì— ì‚¬ìš©í•´ì„œ ì‘ì—…ì„ ë” ë¹¨ë¦¬ ì²˜ë¦¬í•´ë³´ë„ë¡ í•˜ì

## ğŸ§µìŠ¤ë ˆë“œ í’€ ì‚¬ìš©
```java
        ExecutorService es = Executors.newFixedThreadPool(2);

        // 1. ì‘ì—…ì„ ë¶„í• í•œë‹¤.
        SumTask task1 = new SumTask(1, 4);
        SumTask task2 = new SumTask(5, 8);

        // 2. ë¶„í• í•œ ì‘ì—…ì„ ì²˜ë¦¬í•œë‹¤.
        Future<Integer> future1 = es.submit(task1);
        Future<Integer> future2 = es.submit(task2);

        //3. join - ì²˜ë¦¬í•œ ê²°ê³¼ë¥¼ í•©ì¹¨, get - ê²°ê³¼ê°€ ë‚˜ì˜¬ ë–„ê¹Œì§€ ëŒ€ê¸°
        Integer result1 = future1.get();
        Integer result2 = future2.get();

        int sum = result1 + result2;
        es.shutdown(); // ìë°” 19+ë¶€í„° es.close()ê°€ ê°€ëŠ¥
```
- `Executors.newFixedThreadPool(2)` â†’ **ìµœëŒ€ 2ê°œì˜ ìŠ¤ë ˆë“œ**ë¥¼ ì œê³µ

```java
    static class SumTask implements Callable<Integer> {
        int startValue;
        int endValue;

        public SumTask(int startValue, int endValue) {
            this.startValue = startValue;
            this.endValue = endValue;
        }

        @Override
        public Integer call() {
            log("ì‘ì—… ì‹œì‘");
            int sum = 0;
            for (int i = startValue; i <= endValue; i++) {
                int calculated = HeavyJob.heavyTask(i);
                sum += calculated;
            }
            log("ì‘ì—… ì™„ë£Œ result: " + sum);
            return sum;
        }
    }
```
- `SumTask` ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ ì‘ì—…ì„ ë‘ê°œë¡œ **ë¶„í• **
- `submit` ë©”ì„œë“œë¥¼ í†µí•´ **ìŠ¤ë ˆë“œ í’€ ì‘ì—…**
- `Future` ê°ì²´ë¥¼ ë°›ê³  ì‹¤ì œ ê²°ê³¼ê°€ ë‚˜ì˜¬ë•Œê¹Œì§€ **ëŒ€ê¸°**

ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ í†µí•´ ì‹¤í–‰ì‹œê°„ì´ ë” ë‹¨ì¶•ë˜ê³  `Future`ë¡œ ë°˜í™˜ê°’ì„ ì‰½ê²Œ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤.<br>
í•˜ì§€ë§Œ ê°œë°œìê°€ **ë¶„í• /ë³‘í•© ë¡œì§**ì„ ì§ì ‘ ì§œì•¼í•˜ëŠ” ë‹¨ì ì´ ìˆë‹¤

---

## ğŸ”„ Fork/Join íŒ¨í„´

ì§€ê¸ˆê¹Œì§€ëŠ” ê°œë°œìê°€ ì‘ì—…ì„ ì§ì ‘ ë¶„í• í•˜ê³  ì²˜ë¦¬í•˜ê³  ì²˜ë¦¬ëœ ê²°ê³¼ë¥¼ í•©ì³¤ë‹¤<br>
í•˜ì§€ë§Œ ìë°”ì—ì„œ `Fork/Join` í”„ë ˆì„ì›Œí¬ë¥¼ í†µí•´ ìœ„ íŒ¨í„´ì„ ë” ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

```java
public class ForkJoinMain1 {
    public static void main(String[] args) {
        List<Integer> data = IntStream.rangeClosed(1, 8)
                .boxed()
                .toList();

        //forkJoinPool ìƒì„± ë° ì‘ì—… ìˆ˜í–‰
        ForkJoinPool pool = new ForkJoinPool(10);
        SumTask task = new SumTask(data); //1-8

        //ë³‘ë ¬ë¡œ í•©ì„ êµ¬í•œ í›„ ê²°ê³¼ ì¶œë ¥
        Integer result = pool.invoke(task);
    }
}
```
`ForkJoinPool`ì„ ìƒì„±í•´ì„œ **ìµœëŒ€ 10ì˜ ìŠ¤ë ˆë“œ**ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìŠ¤ë ˆë“œ í’€ì„ ìƒì„±í•œë‹¤.
`pool.invoke(task)`ë¥¼ í†µí•´ `SumTask`ë¥¼ ìŠ¤ë ˆë“œ í’€ì— ì „ë‹¬í•´ì„œ **ë³‘ë ¬ ì‹¤í–‰ì„ ì‹œì‘í•œë‹¤.**

```java
    @Override
    protected Integer compute() {
        //ì‘ì—… ë²”ìœ„ê°€ ì‘ìœ¼ë©´ ì§ì ‘ í™•ì‚°
        if (list.size() <= THRESHOLD) {
            int sum = list.stream()
                    .mapToInt(Integer::intValue)
                    .sum();
            return sum;
        } else {
            //ì‘ì—… ë²”ìœ„ê°€ í¬ë©´ ë°˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë³‘ë ¬ ì²˜ë¦¬
            int mid = list.size() / 2;
            List<Integer> leftList = list.subList(0, mid);
            List<Integer> rightLIst = list.subList(mid, list.size());

            SumTask leftTask = new SumTask(leftList);
            SumTask rightTask = new SumTask(rightLIst);

            //ì™¼ìª½ ì‘ì—…ì€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ì²˜ë¦¬
            leftTask.fork();
            
            // ì˜¤ë¥¸ìª½ ì‘ì—…ì€ í˜„ì œ ìŠ¤ë ˆë“œì—ì„œ ì²˜ë¦¬
            int rightResult = rightTask.compute();

            //ì™¼ìª½ ì‘ì—… ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¼
            int leftResult = leftTask.join();
            
            //ì™¼ìª½ê³¼ ì˜¤ë¥¸ìª½ ì‘ì—… ê²°ê³¼ í•©ì¹¨
            int joinSum = leftResult + rightResult;
            return joinSum;
        }
    }
```
ì¦‰, `SumTask` í´ë˜ìŠ¤ì—ì„œ `compute()` ë‚´ë¶€ì—ì„œ ì‘ì—…ì˜ ë¡œì§ì„ ì •ì˜í•˜ê³ ,
`ForkJoinMain1` í´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ `invoke()`ë¥¼ í†µí•´ ì‹¤ì œ ì‘ì—… ì‹¤í–‰ ê³¼ì •ìœ¼ë¡œ ì§„í–‰ëœë‹¤.

---

## ğŸ›ï¸ Fork/Join í”„ë ˆì„ì›Œí¬ - ê³µìš© í’€
**ê³µìš© í’€(common pool)**ì€ `Fork/Join` ì‘ì—…ì„ ìœ„í•´ ìë°”ê°€ ì œê³µí•˜ëŠ” ìŠ¤ë ˆë“œ í’€ì´ë‹¤.

```java
List<Integer> data  = IntStream.rangeClosed(1, 8)
                        .boxed()
                        .toList();

	SumTask task =  new SumTask(data);
	Integer result = task.invoke(); //ê³µìš© í’€ ì‚¬ìš©
```
ì´ì „ì—ëŠ” `ForkJoinPool` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´<br>
`pool.invoke(take)`ë¥¼ í†µí•´ í’€ì— ì§ì ‘ ì‘ì—…ì„ ìš”ì²­í–ˆë‹¤.

í•˜ì§€ë§Œ ê³µìš©í’€ì„ ì‚¬ìš©í•˜ë©´ ë³„ë„ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì§€ ì•Šì•„ë„<br>
**ìë°”ê°€ ê³µìš©í’€ì„ ì‚¬ìš©í•´ ë³‘ë ¬ ì²˜ë¦¬**ë¥¼ í•˜ê²Œ ë„ì™€ì¤€ë‹¤.

ê³µìš©í’€ì€ `JVM`ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ìœ ì§€ë˜ê¸° ë•Œë¬¸ì— **ë³„ë„ë¡œ í’€ì„ ì¢…ë£Œí•˜ì§€ ì•Šì•„ë„ ëœë‹¤.**

---

### ğŸ“Œ Fork/Join ê³µìš© í’€ì˜ íŠ¹ì§•
- ì‹œìŠ¤í…œ ì „ì²´ì—ì„œ ê³µìœ 
  - ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ **ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤**ë¡œ ê³µìœ ë¨
- ìë™ ìƒì„±ê³¼ í¸ë¦¬í•œ ì‚¬ìš©
  - ë³„ë„ë¡œ ìƒì„± x, `ForkJoinPool.commonPool()`ë¥¼ í†µí•´ ì ‘ê·¼ ê°€ëŠ¥
- ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ í™œìš©
  - **ìë°” 8ì˜ ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ë‚´ë¶€ì ìœ¼ë¡œ ê³µìš© í’€** ì‚¬ìš©
- ìì› íš¨ìœ¨ì„±
  - ì—¬ëŸ¬ ê³³ì—ì„œ ë³„ë„ í’€ì„ ìƒì„±í•˜ëŠ” ëŒ€ì‹ ì— **ê³µìš© í’€ì„ ì‚¬ìš©í•´ ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬**
- ë³‘ë ¬ ìˆ˜ì¤€ ìë™ ì„¤ì •
  - ì‹œìŠ¤í…œì˜ ê°€ìš© í”„ë¡œì„¸ì„œ ìˆ˜ì—ì„œ **1ì„ ëº€ ê°’ìœ¼ë¡œ ë³‘ë ¬ ìˆ˜ì¤€ì´ ì„¤ì •**ë¨

---

## ğŸ†š ê³µìš© í’€ vs ì»¤ìŠ¤í…€ í’€
ê·¸ëŸ¼ ì»¤ìŠ¤í…€ í’€ê³¼ ê³µìš© í’€ì˜ ì°¨ì´ì ì€ ë¬´ì—‡ì¼ê¹Œ?

### ì»¤ìŠ¤í…€ Fork/Join í’€
```java
ForkJoinPool pool = new ForkJoinPool();
Integer result = pool.invoke(task);
```

### ê³µìš© í’€
```java
Integer result = task.invoke();
```


### ì°¨ì´ì 

|        | ì»¤ìŠ¤í…€ í’€                                   | ê³µìš© í’€                                   |
|-------------------|--------------------------------------------|-------------------------------------------|
| **ìì› ê´€ë¦¬**     | ëª…ì‹œì ìœ¼ë¡œ ìƒì„±/ê´€ë¦¬ í•„ìš”                   | JVMì´ ìë™ ê´€ë¦¬                           |
| **ì¬ì‚¬ìš©ì„±**      | íŠ¹ì • ì‘ì—… ì „ìš© (ë‹¤ì¤‘ ê³µìœ  ë¶ˆê°€)             | ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê³µìœ  ê°€ëŠ¥            |
| **ì„¤ì • ì œì–´**     | ë³‘ë ¬ ìˆ˜ì¤€, ìŠ¤ë ˆë“œ íŒ©í† ë¦¬ ë“± ì„¸ë¶€ ì„¤ì • ê°€ëŠ¥ | JVM ê¸°ë³¸ ì„¤ì • ì‚¬ìš© (ìˆ˜ì • ë¶ˆê°€)            |
| **ë¼ì´í”„ì‚¬ì´í´**  | `shutdown()`ìœ¼ë¡œ ëª…ì‹œì  ì¢…ë£Œ í•„ìš”           | JVM ì¢…ë£Œ ì‹œ ìë™ í•´ì œ (ê´€ë¦¬ ë¶ˆí•„ìš”)        |
| **ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤** | ë…ë¦½ì ì¸ ë³‘ë ¬ ì²˜ë¦¬ í™˜ê²½ í•„ìš” ì‹œ             | ì¼ë°˜ì ì¸ ë³‘ë ¬ ì‘ì—… ì²˜ë¦¬ ì‹œ                |


---

## âš¡ ìë°” ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼
```java
int sum = IntStream.rangeClosed(1, 8)
            .parallel() //ì¶”ê°€
            .map(HeavyJob::heavyTask)
            .reduce(0, (a, b) -> a + b);//sum()
```
`parallel()` ë©”ì„œë“œë§Œ í˜¸ì¶œí•˜ë©´ ì§ì ‘ ìŠ¤ë ˆë“œë¥¼ ë§Œë“¤ í•„ìš” ì—†ì´ **ìŠ¤íŠ¸ë¦¼ì´ ìë™ìœ¼ë¡œ ë³‘ë ¬ ì²˜ë¦¬**ëœë‹¤.<br>
ë”°ë¼ì„œ  `parallel()` ì„ ì–¸ì„ í†µí•´ ë³µì¡í•œ ë©€í‹°ìŠ¤ë ˆë“œ ì½”ë“œ ì—†ì´ ìŠ¤íŠ¸ë¦¼ì„ ë³‘ë ¬ë¡œ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

---

## âš ï¸  ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ ì‚¬ìš©ì‹œ ì£¼ì˜ì 
ë³‘ë ¬ìŠ¤íŠ¸ë¦¼ì€ ê¸°ë³¸ì ìœ¼ë¡œ **CPU ì½”ì–´ ìˆ˜ì— ë§ì¶° ìŠ¤ë ˆë“œê°€ í• ë‹¹**ë˜ê¸°ì—<br>
**ì—°ì‚°ì´ ë§ì€ CPU ë°”ìš´ë“œ ì‘ì—…**ì—ì„œ ì„±ëŠ¥ ì´ì ì„ ë³¼ ìˆ˜ ìˆì§€ë§Œ<br>
`parallel()`ë¥¼ ì‚¬ìš©í•œ ë³‘ë ¬ ìŠ¤íŠ¸ë¦¼ì€ ìŠ¤ë ˆë“œê°€ ì£¼ë¡œ ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” **I/O ë°”ìš´ë“œ ì‘ì—…**ì—ëŠ” ì í•©í•˜ì§€ ì•Šë‹¤.

ê³µìš©í’€ì€ **ë³„ë„ì˜ í’€ ìƒì„± ì—†ì´ íš¨ìœ¨ì ì¸ ë³‘ë ¬ ì²˜ë¦¬**ê°€ ê°€ëŠ¥í•˜ì§€ë§Œ<br>
ë¸”ë¡œí‚¹ ì‘ì—…ì´ë‚˜ íŠ¹ìˆ˜í•œ ì„¤ì •ì´ í•„ìš”í•  ê²½ìš°ì—ëŠ” ì»¤ìŠ¤í…€ í’€ì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.

> ### ì‹¤ë¬´ì—ì„œ **ê³µìš© í’€ì€ ì ˆëŒ€ I/O ë°”ìš´ë“œ ì‘ì—… âŒ **
> ê³µìš© í’€ì„ í†µí•´ ì™¸ë¶€ API í˜¸ì¶œì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ê³  ê¸°ë‹¤ë¦¬ëŠ” ê²½ìš°,
> ì™¸ë¶€ APIë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì‘ë‹µì´ ëŠ¦ê²Œ ì˜¨ë‹¤ë©´ **ê³µìš© í’€ ë‚´ ìŠ¤ë ˆë“œ ëª¨ë‘ I/O ì‘ë‹µì„ ëŒ€ê¸°**
> ** <span style="color:#CD5C5C"> ì¦‰, ëª¨ë“  ìš”ì²­ì´ ê³µìš© í’€ì˜ ìŠ¤ë ˆë“œë¥¼ ê¸°ë‹¤ë¦¬ë©° ì‘ì—…ì´ ë‹¤ ëŒ€ê¸°ë˜ì–´ ë°€ë¦¬ê²Œ ëœë‹¤.</span>**


---

## âœ… ëŒ€ì•ˆ : ë³„ë„ì˜ í’€ ì‚¬ìš©
`I/O` ë°”ìš´ë“œ ì‘ì—…ì²˜ëŸ¼ ëŒ€ê¸°ê°€ ê¸´ ê²½ìš° **ì „ìš© ìŠ¤ë ˆë“œ í’€ì„ ë§Œë“¤ì–´ ì‚¬ìš©**í•˜ëŠ” ê²ƒì´ ê¶Œì¥ëœë‹¤.

```java
    public static void main(String[] args) throws InterruptedException {

        ExecutorService requestPool = Executors.newFixedThreadPool(100);

        //logic ì²˜ë¦¬ ì „ìš© ìŠ¤ë ˆë“œ í’€ ì¶”ê°€
        ExecutorService logicPool = Executors.newFixedThreadPool(400);

        int nThreads = 3;
        for (int i = 0; i < nThreads; i++) {
            String requestName = "request" + i;
            requestPool.submit(() -> logic(requestName, logicPool));
            Thread.sleep(100);
        }
        requestPool.shutdown();
        logicPool.shutdown();
    }
```
**ìµœëŒ€ 400ê°œì˜ ìŠ¤ë ˆë“œ**ë¥¼ ê°€ì§„ ë³„ë„ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” **ì „ìš© ìŠ¤ë ˆë“œë¥¼ ì¶”ê°€í•´ì„œ ë³‘ë ¬ ì‘ì—… ì²˜ë¦¬**ë¥¼ í•˜ëŠ” ì½”ë“œì´ë‹¤.
```java
    private static void logic(String requestName, ExecutorService es) {
    
        long startTime = System.currentTimeMillis();

        List<Future<Integer>> futures = IntStream.range(1, 4)
                .mapToObj(i -> es.submit(() -> HeavyJob.heavyTask(i, requestName)))
                .toList();

        int sum = futures.stream()
                .mapToInt(f -> {
                    try {
                        return f.get();
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                }).sum();
    }
```
ì´ë ‡ê²Œ **ì „ìš© ìŠ¤ë ˆë“œ í’€**ì„ ë§Œë“¤ì–´ ì²˜ë¦¬í•˜ë©´ **ìš”ì²­ë³„ ì²˜ë¦¬ ì‹œê°„ì´ ì§€ì—°ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°**í•  ìˆ˜ ìˆê³ ,<br>
ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•´ **ê³µìš© í’€ ë³‘ëª© í˜„ìƒì„ ë§‰ì„ ìˆ˜ ìˆë‹¤.**

---

## âš ï¸ CompletableFuture ì£¼ì˜ì 

`Future`ì™€ ë§ˆì°¬ê°€ì§€ë¡œ `CompletableFuture` ë˜í•œ ë¹„ë™ê¸° ì‘ì—…ì„ ì‰½ê²Œ ì‹¤í–‰ì‹œì¼œì£¼ëŠ” ë„êµ¬ì´ë‹¤.

```java
 public static void main(String[] args) throws InterruptedException {
        CompletableFuture.runAsync(() -> log("Fork/Join")); // fork/join ê³µìš© í’€

        ExecutorService es = Executors.newFixedThreadPool(100);
        CompletableFuture.runAsync(() -> log("Custom Pool"), es);
        Thread.sleep(100);
        es.shutdown();
    }
    
  // ------ ì‹¤í–‰ ê²°ê³¼ -------
        10:14:58.397 [pool-1-thread-1] Custom Pool
        10:14:58.397 [ForkJoinPool.commonPool-worker-1] Fork/Join
```
ê·¸ëŸ¬ë‚˜ `CompletableFuture`ë¥¼ ìƒì„±í• ë•Œ<br>
ë³„ë„ì˜ ìŠ¤ë ˆë“œ í’€ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ `Fork/Join` ê³µìš©í’€ì´ ì‚¬ìš©ëœë‹¤.<br>
**ë°˜ë“œì‹œ ì»¤ìŠ¤í…€ í’€ì„ ì§€ì •í•´ì„œ ì‚¬ìš©í•´ì•¼í•œë‹¤.**

---

## ğŸ¯ ê²°ë¡ 
ë³‘ë ¬ìŠ¤íŠ¸ë¦¼ì€ `CPU ë°”ìš´ë“œ ì‘ì—…`ì´ ë¹ ë¥´ê³ , ì‰½ê²Œ ë³‘ë ¬ ì²˜ë¦¬ê°€ ë¹ ë¥´ì§€ë§Œ<br>
ê¸°ë³¸ì ìœ¼ë¡œ **ê³µìš©í’€ì„ ì‚¬ìš©í•œë‹¤ëŠ” ì ì—ì„œ ì£¼ì˜**ê°€ í•„ìš”í•˜ë‹¤.

ë¬´ì¡°ê±´ **ê³µìš©í’€ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ì»¤ìŠ¤í…€ í’€ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì ˆëŒ€ ì§€ì–‘**í•´ì•¼í•œë‹¤.<br>
ì‘ì—… íŠ¹ì„±ê³¼ ì‹œìŠ¤í…œ í™˜ê²½ì„ ê³ ë ¤í•´ì„œ `Fork/Join` ê³µìš©í’€ì´ë‚˜ ë³„ë„ì˜ ìŠ¤ë ˆë“œ í’€ì„<br>
ì•Œë§ê²Œ ì¡°í•©í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ êµ‰ì¥íˆ ì¤‘ìš”í•˜ë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.
